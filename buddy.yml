- pipeline: "CI"
  trigger_mode: "${TRIGGER_MODE}"
  ref_name: "${REF_NAME}"
  ref_type: "${REF_TYPE}"
  clone_depth: 1
  trigger_condition: "ALWAYS"
  actions:
    - action: "Execute: composer test"
      type: "BUILD"
      working_directory: "/app"
      region: "eu-west-1"
      docker_image_name: "${PROJECT_NAME}"
      docker_image_tag: "latest"
      execute_commands:
        - "composer install --no-interaction --prefer-dist"
        - "composer test"
        - ""
      services:
        - type: "MYSQL"
          version: "5.7"
          connection:
            host: "mysql_${PROJECT_NAME}"
            port: 3306
            user: "${MYSQL_USER}"
            password: "${MYSQL_PASSWORD}"
            db: "${PROJECT_NAME}"
      mount_filesystem_path: "/app"
      shell: "SH"
      trigger_condition: "ALWAYS"
    - action: "Send notification to ci channel"
      type: "SLACK"
      trigger_time: "ON_FAILURE"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_EXECUTION_REVISION_COMMITTER_EMAIL>"
      channel: "CHCH38Q4T"
      channel_name: "ci"
      attachments:
        - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"danger\",\"fields\":[{\"title\":\"Failed execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"$BUDDY_EXECUTION_BRANCH\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
      trigger_condition: "ALWAYS"

- pipeline: "Deploy"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  clone_depth: 1
  trigger_condition: "ALWAYS"
  actions:
    - action: "Build Docker image"
      type: "DOCKERFILE"
      region: "eu-west-1"
      docker_image_tag: "$BUDDY_EXECUTION_REVISION,latest"
      dockerfile_path: "Dockerfile"
      repository: "${PROJECT_NAME}"
      build_args:
        - "APP_ENV=${APP_ENV}"
      trigger_condition: "ALWAYS"
    - action: "Execute: composer ci"
      type: "BUILD"
      working_directory: "/app"
      use_image_from_action: true
      execute_commands:
        - "echo -e \"[supervisord]\\nnodaemon=false\" > /etc/supervisor.d/zzzzz-tests.ini"
        - "/usr/bin/supervisord -c /etc/supervisord.conf"
        - "mkdir -p /app/var/cache/prod"
        - "chown -R nginx:nginx /app/var/"
        - "composer install --no-interaction --prefer-dist"
        - "composer ci"
        - ""
      services:
        - type: "MYSQL"
          version: "5.7"
          connection:
            host: "mysql_${PROJECT_NAME}"
            port: 3306
            user: "${MYSQL_USER}""
            password: "${MYSQL_PASSWORD}"
            db: "${PROJECT_NAME}"
        - type: "REDIS"
          version: "3.2.1"
          connection:
            host: "redis"
            port: 6379
      mount_filesystem_disable: true
      mount_filesystem_path: "/app"
      shell: "SH"
      trigger_condition: "ALWAYS"
      variables:
        - key: "DATABASE_URL"
          value: "mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@mysql_${PROJECT_NAME}:3306/${PROJECT_NAME}"
          description: ""
        - key: "REDIS_HOST"
          value: "redis"
          description: ""
        - key: "SENTRY_DSN"
          value: ""
          description: ""
        - key: "WIDGETML_ENDPOINT"
          value: ""
          description: ""
    - action: "Kubernetes - set image"
      type: "KUBERNETES_SET_IMAGE"
      container: "${PROJECT_NAME}"
      cluster: "landingi-prod"
      region: "eu-west-1"
      namespace: "production"
      deployment: "${PROJECT_NAME}"
      image_name: "084824767965.dkr.ecr.eu-west-1.amazonaws.com/${PROJECT_NAME}"
      kubectl_version: "v1.13.2"
      image_tag: "$BUDDY_EXECUTION_REVISION"
      record_arg: "NOT_SET"
      trigger_condition: "ALWAYS"
    - action: "Send notification to cd channel"
      type: "SLACK"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
      channel: "CK9LNLJ1W"
      channel_name: "cd"
      attachments:
        - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"good\",\"fields\":[{\"title\":\"Successful execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"$BUDDY_EXECUTION_BRANCH\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
      trigger_condition: "ALWAYS"
    - action: "Send notification to cd channel"
      type: "SLACK"
      trigger_time: "ON_FAILURE"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_EXECUTION_REVISION_COMMITTER_EMAIL>"
      channel: "CK9LNLJ1W"
      channel_name: "cd"
      attachments:
        - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"danger\",\"fields\":[{\"title\":\"Failed execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"$BUDDY_EXECUTION_BRANCH\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
      trigger_condition: "ALWAYS"
- pipeline: "CI"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "(^((?!master$).)*$)"
  ref_type: "WILDCARD"
  clone_depth: 1
  trigger_condition: "ALWAYS"
  actions:
    - action: "Execute: composer test"
      type: "BUILD"
      working_directory: "/app"
      region: "eu-west-1"
      docker_image_name: "${PROJECT_NAME}"
      docker_image_tag: "latest"
      execute_commands:
        - "composer install --no-interaction --prefer-dist"
        - "composer test"
        - ""
      services:
        - type: "MYSQL"
          version: "5.7"
          connection:
            host: "mysql_${PROJECT_NAME}"
            port: 3306
            user: "${MYSQL_USER}"
            password: "${MYSQL_PASSWORD}"
            db: "${PROJECT_NAME}"
      mount_filesystem_path: "/app"
      shell: "SH"
      trigger_condition: "ALWAYS"
    - action: "Send notification to ci channel"
      type: "SLACK"
      trigger_time: "ON_FAILURE"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_EXECUTION_REVISION_COMMITTER_EMAIL>"
      channel: "CHCH38Q4T"
      channel_name: "ci"
      attachments:
        - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"danger\",\"fields\":[{\"title\":\"Failed execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Branch\",\"value\":\"$BUDDY_EXECUTION_BRANCH\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
      trigger_condition: "ALWAYS"
